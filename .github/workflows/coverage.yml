name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 cmake
        pip install gcovr

    - name: Configure CMake
      run: |
        # Use GCC-12 and enable coverage flags
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_C_FLAGS="--coverage -fno-inline -fno-inline-small-functions -fno-default-inline -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build
      run: cmake --build build

    - name: Run Comparative Analysis (Copilot vs GPT-4o vs Qwen)
      run: |
        # ============================================
        # SETUP
        # ============================================
        # Clear any previous run data
        find . -name "*.gcda" -delete
        
        # Initialize the result file
        echo "üìä THESIS COMPARISON REPORT" > comparison_results.txt
        echo "=============================================" >> comparison_results.txt

        # ============================================
        # ROUND 1: GITHUB COPILOT (Baseline)
        # ============================================
        echo "üß™ RUNNING ROUND 1: COPILOT"
        
        # Run Copilot binaries (Ignore errors with || true so the report continues)
        ./build/test_lru || true
        ./build/test_threadpool || true
        ./build/test_bank || true

        echo "--- COPILOT SCORES ---" >> comparison_results.txt
        # Capture coverage, append to report
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt
        
        # CLEANUP: Delete Copilot data so it doesn't count towards the next agent
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 2: GPT-4o (3-Agent)
        # ============================================
        echo "üß™ RUNNING ROUND 2: GPT-4o (3-AGENT)"
        
        ./build/test_lru_3agent || true
        ./build/test_threadpool_3agent || true
        ./build/test_bank_3agent || true

        echo -e "\n--- GPT-4o SCORES ---" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt

        # CLEANUP
        find . -name "*.gcda" -delete

        # ============================================
        # ROUND 3: QWEN (3-Agent)
        # ============================================
        echo "üß™ RUNNING ROUND 3: QWEN (3-AGENT)"
        
        # This is the part you were likely missing!
        ./build/test_lru_qwen || true
        ./build/test_threadpool_qwen || true
        ./build/test_bank_qwen || true

        echo -e "\n--- QWEN SCORES ---" >> comparison_results.txt
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary >> comparison_results.txt

        # ============================================
        # FINAL REPORT
        # ============================================
        echo "#############################################"
        echo "      üèÜ FINAL THESIS COMPARISON REPORT      "
        echo "#############################################"
        # Print the text file to the console logs
        cat comparison_results.txt
