name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12 cmake
        pip install gcovr

    - name: Configure CMake
      run: |
        # Clean build folder to ensure no old flags remain
        rm -rf build
        
        # Configure using GCC 12
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_C_COMPILER=gcc-12

    - name: Build
      run: cmake --build build

    - name: Run Copilot Tests
      run: |
        echo "ðŸ§ª RUNNING COPILOT TESTS..."
        ./build/test_lru || true
        ./build/test_threadpool || true
        ./build/test_bank || true

    - name: Generate Coverage Report
      run: |
        echo "============================================="
        echo "ðŸ“Š COPILOT COVERAGE REPORT"
        echo "============================================="
        
        # Line Coverage
        echo "ðŸ“‹ LINE COVERAGE:"
        gcovr -r . -f src/ --gcov-executable gcov-12 --print-summary
        
        # Branch Coverage
        echo -e "\nðŸŒ¿ BRANCH COVERAGE:"
        gcovr -r . -f src/ --gcov-executable gcov-12 --branches
