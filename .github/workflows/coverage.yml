name: C++ Unit Tests & Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake clang llvm

    - name: Configure (coverage enabled)
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_FLAGS="-O0 -g -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_CXX_FLAGS="-O0 -g -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_EXE_LINKER_FLAGS="-fprofile-instr-generate"

    - name: Build
      run: |
        cmake --build build

    - name: Run tests
      run: |
        # Set profile file pattern so tests write distinct raw data
        export LLVM_PROFILE_FILE="build/code-%m.profraw"
        ctest --test-dir build --output-on-failure

    - name: Generate coverage report
      run: |
        # 1. Merge all raw profile data into one index
        llvm-profdata merge -sparse build/*.profraw -o build/coverage.profdata

        # 2. Generate Report
        # Important: We must list EVERY test executable using -object
        # We allow looking at 'src/' or 'include/' to find header code
        llvm-cov report \
          build/test_bank \
          -object build/test_lru \
          -object build/test_threadpool \
          -instr-profile=build/coverage.profdata \
          -ignore-filename-regex="test_.*" \
          -ignore-filename-regex="googletest/*"

